{% extends "events/event_base.html" %}
{% load url from future %}
{% block head_title %}
Programme
{% endblock %}

{% block nav_search %}
	{% include '_search_bar.html' with action_url_name='events-map' %}
{% endblock %}

{% block tab %}
	<ul class="nav nav-tabs">
		<li class="active"><a href="{% url 'events-map' %}">Map</a></li>
	  	<li><a href="{% url 'events-list' %}">List</a></li>
	</ul>
	{% include 'participant/category_filter.html' with action_url_name='events-map' %}
	<div class="row">
			<div class="span6">
	    	{% include "maps/_map.html" %}
	        <style type="text/css">
	            #map_canvas{
	                height: 400px;
	            }
	        </style>
	        {% if map_bounds %}
				<script type="text/javascript">
					$(window).ready(function(){ 
	                	SSOUK.map_handler.map.fitBounds({{map_bounds}});
	             	});
	            </script>
	        {% endif %}
		</div>	
		  <div class="span6">
		  	
		  	
	  	{% for event_obj in object_list %}		  	
    		{% include "events/_event_snippet.html" %}  	
		    <script type="text/javascript">
               $(document).ready(function(){
               	var info_text_ul_opening = "<ul class=\"unstyled\">"
               	var info_list_format = "<li><a href=\"{% url 'event-detail' event_obj.id %}\">{{ event_obj.name }}</a></li>";
               	var info_text_ul_closing = "</ul>";
               	
               	{# if the marker exist we update it#}
               	if ({{event_obj.location.id}} in SSOUK.map_handler.markers)
               	{	
           			var info_list = SSOUK.map_handler.location_to_item[{{event_obj.location.id}}];
           			info_list += info_list_format;
           			var info_text = info_text_ul_opening + info_list + info_text_ul_closing;
       			   	SSOUK.map_handler.location_to_item[{{event_obj.location.id}}] = info_list;
       			   	marker = SSOUK.map_handler.markers[{{event_obj.location.id}}];
       			   	marker.data.popuptext = info_text;
       			   	marker.unbindPopup();
       			   	marker.bindPopup(info_text);
               	}
               	{# otherwise we create it #}
               	else 
               	{	
               		var info_list = info_list_format;
	               	var info_text = info_text_ul_opening + info_list + info_text_ul_closing;
	               	SSOUK.map_handler.location_to_item[{{event_obj.location.id}}] = info_list;
   		           	SSOUK.map_handler.updateMarker({{ event_obj.location.marker.y }}, 
	                          {{ event_obj.location.marker.x }},
	                          info_text,
	                          {{ event_obj.location.id }}
	                          );
	                
	             }
               }); 
			</script>
			
	    {% endfor %}
		</div>
	</div>
{% endblock%}
